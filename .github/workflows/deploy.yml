name: Deploy

on:
  push:
    branches: [main]
    paths: ['src/**']
  workflow_dispatch:

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}

jobs:
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      changed-services: ${{ steps.changes.outputs.changed-services }}
      matrix: ${{ steps.changes.outputs.matrix }}
      has-changes: ${{ steps.changes.outputs.has-changes }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed services
        id: changes
        run: |
          SERVICES=("ui" "catalog" "cart" "checkout" "orders")
          CHANGED_SERVICES=()

          echo "ðŸ” Checking for changes..."

          for service in "${SERVICES[@]}"; do
            if git diff --name-only HEAD~1 HEAD | grep -q "^src/$service/" || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              CHANGED_SERVICES+=("$service")
              echo "âœ… $service changed"
            else
              echo "â­ï¸ $service unchanged"
            fi
          done

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            CHANGED_SERVICES=("${SERVICES[@]}")
          fi

          if [ ${#CHANGED_SERVICES[@]} -eq 0 ]; then
            echo "has-changes=false" >> $GITHUB_OUTPUT
